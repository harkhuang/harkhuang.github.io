---
layout: post
title:  "内存暴涨的自我救赎"
date:   2020-01-15 22:00:51 +0800
categories: jekyll update
---


# 出现的问题的描述

序言:
程序需要在每秒中处理10000条左右行情数据,这样的并发量真的是很高
所以在一般的通用编程模型下会产生怪异的问题

问题描述:
程序在本地运行大概100M内存的消耗 并无大碍
程序在windowsserver中运行出现内存跳涨,基本是没几秒钟就跳100K左右内存,而且内存不会降,只会涨.


问题分析:
1.是否是使用的内部zmq消息队列深度堆积导致?
经过排查和api系数调整不是这个原因.

2.是否是因为消息处理慢导致?

注释掉回到函数中自己写的代码,程序居然不在内存暴涨.排除法找问题太容易了.
经过注释的方式排出代码,可能由于回调函数处理过慢,导致消息堆积.
具体是因为服务器上运行服务过多,锁分配的时间片就少,需要的处理时间超时,错过第三方动态库了唯一一次的资源释放的机会,导致内存泄漏.

解决办法:
采用异步方式,对数据处理,尽量减少在回调函数中占用的时间,因为每3秒要调用上万次回调函数,其实压力还是很大的.采用了线程池  异步调用  使用lambda表达式采用[=] 拷贝方式进行参数传递.尽量在回到函数内减少调用的时间.


 